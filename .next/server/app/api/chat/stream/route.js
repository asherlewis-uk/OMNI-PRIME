"use strict";(()=>{var e={};e.id=480,e.ids=[480],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},85807:e=>{e.exports=require("module")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},74026:e=>{e.exports=require("string_decoder")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6162:e=>{e.exports=require("worker_threads")},71568:e=>{e.exports=require("zlib")},87561:e=>{e.exports=require("node:fs")},84492:e=>{e.exports=require("node:stream")},72477:e=>{e.exports=require("node:stream/web")},95638:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>I,requestAsyncStorage:()=>x,routeModule:()=>q,serverHooks:()=>S,staticGenerationAsyncStorage:()=>C});var a={};r.r(a),r.d(a,{GET:()=>h});var o=r(49303),s=r(88716),n=r(60670),i=r(5499),l=r(48645),d=r(57745),p=r(81445),u=r(68628),m=r(55378),c=r(45019),g=r(85538),y=r(84770),f=r.n(y);async function h(e){let{searchParams:t}=new URL(e.url),r=t.get("sessionId"),a=t.get("message");if(!r)return new Response(JSON.stringify({error:"sessionId is required"}),{status:400,headers:{"Content-Type":"application/json"}});if(!a)return new Response(JSON.stringify({error:"message is required"}),{status:400,headers:{"Content-Type":"application/json"}});let o=new AbortController,s=o.signal;return e.signal.addEventListener("abort",()=>{o.abort()}),function(e,t){let r=new TextEncoder;return new Response(new ReadableStream({async start(t){try{for await(let a of e)t.enqueue(r.encode(a));t.close()}catch(e){console.error("[Stream] Error:",e),t.error(e)}},cancel(){t?.()}}),{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}})}(w(r,a,s),()=>{o.abort()})}async function*w(e,t,r){let a=(0,i.V)(),o=f().randomUUID();try{let s=await a.query.chatSessions.findFirst({where:(0,d.eq)(l.fh.id,e),with:{agent:!0}});if(!s||!s.agent){yield`data: ${JSON.stringify({type:"error",error:{code:"SESSION_NOT_FOUND",message:"Session or agent not found"}})}

`;return}let n=f().randomUUID();await a.insert(l.sY).values({id:n,sessionId:e,role:"user",content:t,metadata:{},isComplete:!0});let i=await c.U.getAgentTools(s.agent.id),y=c.U.convertToGatewayTools(i),h=m.R.buildSystemPrompt(s.agent.systemPrompt),w=(await a.query.messages.findMany({where:(0,d.eq)(l.sY.sessionId,e),orderBy:[(0,p.C)(l.sY.createdAt)],limit:10})).reverse().map(e=>({role:e.role,content:e.content}));yield`data: ${JSON.stringify({type:"start",id:o,sessionId:e,messageId:o,timestamp:Date.now()})}

`;let q="",x=[];for await(let n of u.S.streamCompletion({model:s.agent.modelPreference,messages:[{role:"system",content:h},...w,{role:"user",content:t}],tools:y.length>0?y:void 0,temperature:s.agent.temperature,signal:r})){if(r.aborted)break;let t=function(e,t,r){let a={id:t,sessionId:r,messageId:t,timestamp:Date.now()};switch(e.type){case"content":return{...a,type:"content",content:e.content};case"error":return{...a,type:"error",error:e.error??{code:"UNKNOWN",message:"Unknown error"}};case"done":return{...a,type:"complete",metadata:e.finishReason?{model:void 0,provider:void 0}:void 0};default:return{...a,type:e.type}}}(n,o,e);switch(n.type){case"content":n.content&&(q+=n.content,yield`data: ${JSON.stringify(t)}

`);break;case"tool_call":if(n.toolCall){x.push({id:n.toolCall.id,name:n.toolCall.name,arguments:n.toolCall.arguments}),yield`data: ${JSON.stringify({type:"tool_call",id:o,sessionId:e,messageId:o,toolCall:{id:n.toolCall.id,name:n.toolCall.name,arguments:n.toolCall.arguments},timestamp:Date.now()})}

`;let t=await a.query.mcpTools.findFirst({where:(0,d.eq)(l.a$.name,n.toolCall.name)});if(t){let r=f().randomUUID();await a.insert(l.jb).values({id:r,messageId:o,toolId:t.id,toolName:n.toolCall.name,arguments:JSON.parse(n.toolCall.arguments||"{}"),status:"pending"}),await (0,g.pw)({toolCallId:r,serverId:t.serverId,toolName:n.toolCall.name,arguments:JSON.parse(n.toolCall.arguments||"{}"),sessionId:e,messageId:o,requestId:f().randomUUID()}),yield`data: ${JSON.stringify({type:"tool_pending",id:o,sessionId:e,messageId:o,toolCall:{id:r,toolName:n.toolCall.name},timestamp:Date.now()})}

`}}break;case"error":yield`data: ${JSON.stringify(t)}

`;return}}await a.insert(l.sY).values({id:o,sessionId:e,role:"assistant",content:q,agentId:s.agent.id,metadata:{hasToolCalls:x.length>0,toolCallIds:x.map(e=>e.id)},isComplete:!0}),await a.update(l.fh).set({messageCount:s.messageCount+2,lastMessageAt:new Date}).where((0,d.eq)(l.fh.id,e)),await a.update(l.DQ).set({totalMessages:s.agent.totalMessages+1,lastActiveAt:new Date}).where((0,d.eq)(l.DQ.id,s.agent.id)),yield`data: ${JSON.stringify({type:"complete",id:o,sessionId:e,messageId:o,timestamp:Date.now()})}

`}catch(t){console.error("[Stream] Error:",t),yield`data: ${JSON.stringify({type:"error",id:o,sessionId:e,messageId:o,error:{code:"STREAM_ERROR",message:t instanceof Error?t.message:"Stream failed"},timestamp:Date.now()})}

`}}let q=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/chat/stream/route",pathname:"/api/chat/stream",filename:"route",bundlePath:"app/api/chat/stream/route"},resolvedPagePath:"C:\\Users\\asher\\PROJECTS\\OMNI-PRIME\\src\\app\\api\\chat\\stream\\route.ts",nextConfigOutput:"export",userland:a}),{requestAsyncStorage:x,staticGenerationAsyncStorage:C,serverHooks:S}=q,v="/api/chat/stream/route";function I(){return(0,n.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:C})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[948,656,532,148,388],()=>r(95638));module.exports=a})();