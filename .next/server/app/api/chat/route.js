"use strict";(()=>{var e={};e.id=744,e.ids=[744],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},85807:e=>{e.exports=require("module")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},74026:e=>{e.exports=require("string_decoder")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6162:e=>{e.exports=require("worker_threads")},71568:e=>{e.exports=require("zlib")},87561:e=>{e.exports=require("node:fs")},84492:e=>{e.exports=require("node:stream")},72477:e=>{e.exports=require("node:stream/web")},34578:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>j,patchFetch:()=>N,requestAsyncStorage:()=>y,routeModule:()=>v,serverHooks:()=>U,staticGenerationAsyncStorage:()=>R});var s={};r.r(s),r.d(s,{GET:()=>f,POST:()=>w});var o=r(49303),a=r(88716),n=r(60670),i=r(87070),l=r(5499),u=r(48645),d=r(57745),p=r(81445),m=r(68628),c=r(55378),g=r(45019),h=r(85538),x=r(84770),q=r.n(x);async function f(e){try{let{searchParams:t}=new URL(e.url),r=t.get("agentId"),s=parseInt(t.get("limit")??"50",10),o=parseInt(t.get("offset")??"0",10),a=(0,l.V)().query.chatSessions.findMany({where:r?(0,d.eq)(u.fh.agentId,r):void 0,with:{agent:!0,swarm:!0},orderBy:[(0,p.C)(u.fh.lastMessageAt)],limit:s,offset:o}),n=await a;return i.NextResponse.json({sessions:n})}catch(e){return console.error("[Chat API] Error listing sessions:",e),i.NextResponse.json({error:"Failed to list sessions"},{status:500})}}async function w(e){try{let t=await e.json(),{action:r}=t;switch(r){case"create-session":return I(t);case"send-message":return C(t);default:return i.NextResponse.json({error:"Invalid action"},{status:400})}}catch(e){return console.error("[Chat API] Error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function I(e){let{agentId:t,swarmId:r,title:s}=e;if(!t&&!r)return i.NextResponse.json({error:"Either agentId or swarmId is required"},{status:400});try{let e=(0,l.V)(),o=await e.query.userProfiles.findFirst();if(!o)return i.NextResponse.json({error:"User profile not found"},{status:404});let a=q().randomUUID();await e.insert(u.fh).values({id:a,ownerId:o.id,agentId:t??null,swarmId:r??null,title:s??"New Conversation",messageCount:0,isArchived:!1});let n=await e.query.chatSessions.findFirst({where:(0,d.eq)(u.fh.id,a),with:{agent:!0,swarm:!0}});return i.NextResponse.json({session:n},{status:201})}catch(e){return console.error("[Chat API] Error creating session:",e),i.NextResponse.json({error:"Failed to create session"},{status:500})}}async function C(e){let{sessionId:t,content:r}=e;if(!t||!r)return i.NextResponse.json({error:"sessionId and content are required"},{status:400});try{let e=(0,l.V)(),s=await e.query.chatSessions.findFirst({where:(0,d.eq)(u.fh.id,t),with:{agent:!0}});if(!s)return i.NextResponse.json({error:"Session not found"},{status:404});let o=q().randomUUID();await e.insert(u.sY).values({id:o,sessionId:t,role:"user",content:r,metadata:{},isComplete:!0}),await e.update(u.fh).set({messageCount:s.messageCount+1,lastMessageAt:new Date}).where((0,d.eq)(u.fh.id,t));let a=[];if(s.agent){let e=await g.U.getAgentTools(s.agent.id);a=g.U.convertToGatewayTools(e)}let n=q().randomUUID();if(s.agent){let o=c.R.buildSystemPrompt(s.agent.systemPrompt),l=(await e.query.messages.findMany({where:(0,d.eq)(u.sY.sessionId,t),orderBy:[(0,p.C)(u.sY.createdAt)],limit:10})).reverse().map(e=>({role:e.role,content:e.content})),g=await m.S.complete({model:s.agent.modelPreference,messages:[{role:"system",content:o},...l,{role:"user",content:r}],tools:a.length>0?a:void 0,temperature:s.agent.temperature});if(g.toolCalls&&g.toolCalls.length>0)for(let r of g.toolCalls){let s=await e.query.mcpTools.findFirst({where:(0,d.eq)(u.a$.name,r.name)});if(s){let o=q().randomUUID();await e.insert(u.jb).values({id:o,messageId:n,toolId:s.id,toolName:r.name,arguments:r.arguments,status:"pending"}),await (0,h.pw)({toolCallId:o,serverId:s.serverId,toolName:r.name,arguments:r.arguments,sessionId:t,messageId:n,requestId:q().randomUUID()})}}return await e.insert(u.sY).values({id:n,sessionId:t,role:"assistant",content:g.content,agentId:s.agent.id,metadata:{provider:g.provider,model:g.model,hasToolCalls:g.toolCalls&&g.toolCalls.length>0,toolCallIds:g.toolCalls?.map(()=>q().randomUUID())},promptTokens:g.usage.promptTokens,completionTokens:g.usage.completionTokens,totalTokens:g.usage.totalTokens,isComplete:!0}),await e.update(u.fh).set({messageCount:s.messageCount+2,lastMessageAt:new Date,modelUsed:g.model}).where((0,d.eq)(u.fh.id,t)),await e.update(u.DQ).set({totalMessages:s.agent.totalMessages+1,lastActiveAt:new Date}).where((0,d.eq)(u.DQ.id,s.agent.id)),i.NextResponse.json({message:{id:n,content:g.content,role:"assistant",hasToolCalls:g.toolCalls&&g.toolCalls.length>0},toolCalls:g.toolCalls,usage:g.usage})}return i.NextResponse.json({messageId:n,streamUrl:`/api/chat/stream?sessionId=${t}&messageId=${n}`})}catch(e){return console.error("[Chat API] Error sending message:",e),i.NextResponse.json({error:"Failed to send message"},{status:500})}}let v=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/chat/route",pathname:"/api/chat",filename:"route",bundlePath:"app/api/chat/route"},resolvedPagePath:"C:\\Users\\asher\\PROJECTS\\OMNI-PRIME\\src\\app\\api\\chat\\route.ts",nextConfigOutput:"export",userland:s}),{requestAsyncStorage:y,staticGenerationAsyncStorage:R,serverHooks:U}=v,j="/api/chat/route";function N(){return(0,n.patchFetch)({serverHooks:U,staticGenerationAsyncStorage:R})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,656,70,532,148,388],()=>r(34578));module.exports=s})();