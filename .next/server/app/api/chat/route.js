"use strict";(()=>{var e={};e.id=744,e.ids=[744],e.modules={85890:e=>{e.exports=require("better-sqlite3")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},85807:e=>{e.exports=require("module")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},74026:e=>{e.exports=require("string_decoder")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6162:e=>{e.exports=require("worker_threads")},71568:e=>{e.exports=require("zlib")},87561:e=>{e.exports=require("node:fs")},84492:e=>{e.exports=require("node:stream")},72477:e=>{e.exports=require("node:stream/web")},34578:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>S,patchFetch:()=>j,requestAsyncStorage:()=>y,routeModule:()=>v,serverHooks:()=>U,staticGenerationAsyncStorage:()=>R});var r={};s.r(r),s.d(r,{GET:()=>w,POST:()=>f});var o=s(49303),a=s(88716),n=s(60670),i=s(87070),l=s(5499),u=s(48645),d=s(57745),p=s(81445),m=s(68628),c=s(55378),g=s(45019),h=s(85538),x=s(84770),q=s.n(x);async function w(e){try{let{searchParams:t}=new URL(e.url),s=t.get("agentId"),r=parseInt(t.get("limit")??"50",10),o=parseInt(t.get("offset")??"0",10),a=(await (0,l.V)()).query.chatSessions.findMany({where:s?(0,d.eq)(u.chatSessions.agentId,s):void 0,with:{agent:!0,swarm:!0},orderBy:[(0,p.C)(u.chatSessions.lastMessageAt)],limit:r,offset:o}),n=await a;return i.NextResponse.json({sessions:n})}catch(e){return console.error("[Chat API] Error listing sessions:",e),i.NextResponse.json({error:"Failed to list sessions"},{status:500})}}async function f(e){try{let t=await e.json(),{action:s}=t;switch(s){case"create-session":return I(t);case"send-message":return C(t);default:return i.NextResponse.json({error:"Invalid action"},{status:400})}}catch(e){return console.error("[Chat API] Error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function I(e){let{agentId:t,swarmId:s,title:r}=e;if(!t&&!s)return i.NextResponse.json({error:"Either agentId or swarmId is required"},{status:400});try{let e=await (0,l.V)(),o=await e.query.userProfiles.findFirst();if(!o)return i.NextResponse.json({error:"User profile not found"},{status:404});let a=q().randomUUID();await e.insert(u.chatSessions).values({id:a,ownerId:o.id,agentId:t??null,swarmId:s??null,title:r??"New Conversation",messageCount:0,isArchived:!1});let n=await e.query.chatSessions.findFirst({where:(0,d.eq)(u.chatSessions.id,a),with:{agent:!0,swarm:!0}});return i.NextResponse.json({session:n},{status:201})}catch(e){return console.error("[Chat API] Error creating session:",e),i.NextResponse.json({error:"Failed to create session"},{status:500})}}async function C(e){let{sessionId:t,content:s}=e;if(!t||!s)return i.NextResponse.json({error:"sessionId and content are required"},{status:400});try{let e=await (0,l.V)(),r=await e.query.chatSessions.findFirst({where:(0,d.eq)(u.chatSessions.id,t),with:{agent:!0}});if(!r)return i.NextResponse.json({error:"Session not found"},{status:404});let o=q().randomUUID();await e.insert(u.messages).values({id:o,sessionId:t,role:"user",content:s,metadata:{},isComplete:!0}),await e.update(u.chatSessions).set({messageCount:r.messageCount+1,lastMessageAt:new Date}).where((0,d.eq)(u.chatSessions.id,t));let a=[];if(r.agent){let e=await g.U.getAgentTools(r.agent.id);a=g.U.convertToGatewayTools(e)}let n=q().randomUUID();if(r.agent){let o=c.R.buildSystemPrompt(r.agent.systemPrompt),l=(await e.query.messages.findMany({where:(0,d.eq)(u.messages.sessionId,t),orderBy:[(0,p.C)(u.messages.createdAt)],limit:10})).reverse().map(e=>({role:e.role,content:e.content})),g=await m.S.complete({model:r.agent.modelPreference,messages:[{role:"system",content:o},...l,{role:"user",content:s}],tools:a.length>0?a:void 0,temperature:r.agent.temperature});if(g.toolCalls&&g.toolCalls.length>0)for(let s of g.toolCalls){let r=await e.query.mcpTools.findFirst({where:(0,d.eq)(u.mcpTools.name,s.name)});if(r){let o=q().randomUUID();await e.insert(u.toolCalls).values({id:o,messageId:n,toolId:r.id,toolName:s.name,arguments:s.arguments,status:"pending"}),await (0,h.pw)({toolCallId:o,serverId:r.serverId,toolName:s.name,arguments:s.arguments,sessionId:t,messageId:n,requestId:q().randomUUID()})}}return await e.insert(u.messages).values({id:n,sessionId:t,role:"assistant",content:g.content,agentId:r.agent.id,metadata:{provider:g.provider,model:g.model,hasToolCalls:g.toolCalls&&g.toolCalls.length>0,toolCallIds:g.toolCalls?.map(()=>q().randomUUID())},promptTokens:g.usage.promptTokens,completionTokens:g.usage.completionTokens,totalTokens:g.usage.totalTokens,isComplete:!0}),await e.update(u.chatSessions).set({messageCount:r.messageCount+2,lastMessageAt:new Date,modelUsed:g.model}).where((0,d.eq)(u.chatSessions.id,t)),await e.update(u.agents).set({totalMessages:r.agent.totalMessages+1,lastActiveAt:new Date}).where((0,d.eq)(u.agents.id,r.agent.id)),i.NextResponse.json({message:{id:n,content:g.content,role:"assistant",hasToolCalls:g.toolCalls&&g.toolCalls.length>0},toolCalls:g.toolCalls,usage:g.usage})}return i.NextResponse.json({messageId:n,streamUrl:`/api/chat/stream?sessionId=${t}&messageId=${n}`})}catch(e){return console.error("[Chat API] Error sending message:",e),i.NextResponse.json({error:"Failed to send message"},{status:500})}}let v=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/chat/route",pathname:"/api/chat",filename:"route",bundlePath:"app/api/chat/route"},resolvedPagePath:"C:\\Users\\asher\\PROJECTS\\OMNI-PRIME\\src\\app\\api\\chat\\route.ts",nextConfigOutput:"export",userland:r}),{requestAsyncStorage:y,staticGenerationAsyncStorage:R,serverHooks:U}=v,S="/api/chat/route";function j(){return(0,n.patchFetch)({serverHooks:U,staticGenerationAsyncStorage:R})}}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[948,349,70,988,499,388],()=>s(34578));module.exports=r})();